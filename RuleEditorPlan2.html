import React, { useState } from 'react';
import { 
  Plus, 
  Search, 
  Wifi, 
  AlertTriangle, 
  Zap, 
  Clock, 
  Save, 
  Server, 
  FileJson, 
  Trash2, 
  Settings,
  Globe,
  Activity,
  X,
  ShieldAlert,
  FileWarning,
  Check,
  MoreHorizontal,
  PlayCircle,
  Shuffle
} from 'lucide-react';

const MockToolUI = () => {
  const [activeTab, setActiveTab] = useState('response');
  
  // 全局状态
  const [globalChaos, setGlobalChaos] = useState(false);
  const [showChaosConfig, setShowChaosConfig] = useState(false);
  const [globalNetwork, setGlobalNetwork] = useState('Fast 4G'); 

  // 模拟当前 API 数据
  const [currentConfig, setCurrentConfig] = useState({
    status: 200,
    body: '{\n  "code": 0,\n  "message": "success",\n  "data": {\n    "order_id": "ORD-2023-8888",\n    "status": "pending",\n    "amount": 99.00,\n    "tags": ["vip", "fast"]\n  }\n}'
  });

  // 响应库数据
  const [responseLibrary] = useState([
    { id: 1, name: "正常返回 (Happy Path)", status: 200, body: '{\n  "code": 0,\n  "data": { ... }\n}' },
    { id: 2, name: "业务异常 - 余额不足", status: 200, body: '{\n  "code": 1001,\n  "msg": "Balance low"\n}' },
    { id: 3, name: "业务异常 - 订单重复", status: 409, body: '{\n  "code": 40900,\n  "msg": "Order exists"\n}' },
    { id: 4, name: "系统维护中", status: 503, body: '{\n  "error": "Service Unavailable"\n}' },
  ]);

  return (
    <div className="flex h-screen bg-slate-50 text-slate-900 font-sans overflow-hidden flex-col">
      
      {/* ====================================================================================
          1. GLOBAL ENVIRONMENT CONSOLE (Top Bar)
         ==================================================================================== */}
      <div className="h-14 bg-slate-900 text-white flex items-center justify-between px-4 shadow-md z-30 shrink-0 relative">
        <div className="flex items-center gap-2 font-bold text-lg tracking-tight">
          <div className="bg-indigo-600 p-1 rounded">
            <Zap className="w-4 h-4 text-white fill-current" />
          </div>
          <span>MockMaster</span>
        </div>

        <div className="flex items-center gap-6">
          
          {/* Global Network Throttling */}
          <div className="flex items-center gap-3 bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700 hover:border-slate-600 transition-colors group">
            <Globe className="w-4 h-4 text-blue-400 group-hover:text-blue-300" />
            <div className="flex flex-col">
              <span className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Network Profile</span>
              <select 
                value={globalNetwork}
                onChange={(e) => setGlobalNetwork(e.target.value)}
                className="bg-transparent text-xs font-medium text-white focus:outline-none cursor-pointer"
              >
                <option value="No Throttling">No Throttling (WiFi)</option>
                <option value="Fast 4G">Fast 4G (1.5s delay)</option>
                <option value="Slow 3G">Slow 3G (3s delay)</option>
                <option value="Offline">Offline (No Internet)</option>
                <option value="GPRS">GPRS (50kb/s)</option>
              </select>
            </div>
          </div>

          {/* Global Chaos Switch */}
          <div 
            className={`flex items-center gap-3 px-3 py-1.5 rounded-lg border cursor-pointer transition-all ${globalChaos ? 'bg-orange-900/40 border-orange-500' : 'bg-slate-800 border-slate-700 hover:bg-slate-700'}`}
            onClick={() => setShowChaosConfig(!showChaosConfig)}
          >
            <AlertTriangle className={`w-4 h-4 ${globalChaos ? 'text-orange-500 animate-pulse' : 'text-slate-400'}`} />
            <div className="flex flex-col">
              <span className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Chaos Mode</span>
              <div className="flex items-center gap-2">
                <span className={`text-xs font-medium ${globalChaos ? 'text-orange-400' : 'text-white'}`}>
                  {globalChaos ? 'Active (15%)' : 'Disabled'}
                </span>
                <Settings className="w-3 h-3 text-slate-500" />
              </div>
            </div>
          </div>
        </div>

        <div className="w-32 flex justify-end items-center gap-3">
           <div className="flex flex-col items-end">
              <span className="text-xs font-bold text-slate-300">Admin</span>
              <span className="text-[10px] text-green-400 flex items-center gap-1">● Online</span>
           </div>
           <div className="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center text-xs font-bold">AD</div>
        </div>
      </div>

      {/* ====================================================================================
          2. CHAOS CONFIGURATION OVERLAY (Detailed Panel)
         ==================================================================================== */}
      {showChaosConfig && (
        <div className="absolute top-14 left-0 right-0 bottom-0 bg-slate-900/60 backdrop-blur-sm z-20 flex justify-center items-start pt-10 animate-in fade-in duration-200" onClick={() => setShowChaosConfig(false)}>
          <div className="bg-slate-800 text-white w-full max-w-5xl rounded-xl border border-slate-700 shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
            
            {/* Header */}
            <div className="px-6 py-4 border-b border-slate-700 flex justify-between items-center bg-slate-800">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-orange-500/10 rounded-lg">
                  <AlertTriangle className="w-6 h-6 text-orange-500" />
                </div>
                <div>
                  <h3 className="text-lg font-bold text-white">混沌工程控制台 (Chaos Engineering)</h3>
                  <p className="text-xs text-slate-400">全局故障注入策略，用于测试前端应用的健壮性和容错能力。</p>
                </div>
              </div>
              <div className="flex items-center gap-4">
                <div className="flex items-center gap-3 bg-slate-900 px-4 py-2 rounded-lg border border-slate-700">
                  <span className="text-sm font-medium text-slate-300">故障概率</span>
                  <input type="range" className="w-32 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-orange-500" defaultValue="15" />
                  <span className="text-orange-500 font-bold font-mono">15%</span>
                </div>
                <button 
                  onClick={() => setGlobalChaos(!globalChaos)}
                  className={`px-6 py-2 rounded-lg font-bold text-sm transition-all shadow-lg ${globalChaos ? 'bg-orange-600 hover:bg-orange-700 text-white ring-2 ring-orange-500/50' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}
                >
                  {globalChaos ? '停止混沌模式' : '开启混沌模式'}
                </button>
                <button onClick={() => setShowChaosConfig(false)} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400 transition-colors">
                  <X className="w-5 h-5" />
                </button>
              </div>
            </div>

            {/* Body: 3 Columns of Doom */}
            <div className={`p-8 grid grid-cols-3 gap-8 transition-opacity duration-300 ${!globalChaos && 'opacity-50 grayscale pointer-events-none'}`}>
              
              {/* Column 1: Network */}
              <div className="space-y-4">
                <div className="flex items-center gap-2 text-blue-400 font-bold text-sm uppercase tracking-wider mb-2">
                  <Wifi className="w-4 h-4" /> 传输层故障
                </div>
                
                <label className="group flex items-start gap-3 p-4 bg-slate-700/30 rounded-xl border border-slate-700/50 hover:bg-slate-700 hover:border-blue-500/50 cursor-pointer transition-all">
                  <input type="checkbox" defaultChecked className="mt-1 w-4 h-4 rounded border-slate-600 text-blue-500 focus:ring-blue-500 bg-slate-800" />
                  <div>
                    <div className="font-bold text-slate-200 group-hover:text-white">请求超时 (Timeout)</div>
                    <div className="text-xs text-slate-400 mt-1">模拟请求一直挂起，直到前端触发 timeout 逻辑。</div>
                  </div>
                </label>

                <label className="group flex items-start gap-3 p-4 bg-slate-700/30 rounded-xl border border-slate-700/50 hover:bg-slate-700 hover:border-blue-500/50 cursor-pointer transition-all">
                  <input type="checkbox" className="mt-1 w-4 h-4 rounded border-slate-600 text-blue-500 focus:ring-blue-500 bg-slate-800" />
                  <div>
                    <div className="font-bold text-slate-200 group-hover:text-white">连接重置 (Reset)</div>
                    <div className="text-xs text-slate-400 mt-1">TCP 连接直接断开 (ECONNRESET)，模拟网络不稳定。</div>
                  </div>
                </label>

                <label className="group flex items-start gap-3 p-4 bg-slate-700/30 rounded-xl border border-slate-700/50 hover:bg-slate-700 hover:border-blue-500/50 cursor-pointer transition-all">
                  <input type="checkbox" className="mt-1 w-4 h-4 rounded border-slate-600 text-blue-500 focus:ring-blue-500 bg-slate-800" />
                  <div>
                    <div className="font-bold text-slate-200 group-hover:text-white">响应截断 (Partial)</div>
                    <div className="text-xs text-slate-400 mt-1">传输一半数据后中断连接，测试流式处理能力。</div>
                  </div>
                </label>
              </div>

              {/* Column 2: Protocol */}
              <div className="space-y-4">
                <div className="flex items-center gap-2 text-purple-400 font-bold text-sm uppercase tracking-wider mb-2">
                  <ShieldAlert className="w-4 h-4" /> 协议与服务层
                </div>
                
                <label className="group flex items-start gap-3 p-4 bg-slate-700/30 rounded-xl border border-slate-700/50 hover:bg-slate-700 hover:border-purple-500/50 cursor-pointer transition-all">
                  <input type="checkbox" defaultChecked className="mt-1 w-4 h-4 rounded border-slate-600 text-purple-500 focus:ring-purple-500 bg-slate-800" />
                  <div>
                    <div className="font-bold text-slate-200 group-hover:text-white">HTTP 5xx 错误</div>
                    <div className="text-xs text-slate-400 mt-1">随机返回 500, 502, 503, 504 状态码。</div>
                  </div>
                </label>

                <label className="group flex items-start gap-3 p-4 bg-slate-700/30 rounded-xl border border-slate-700/50 hover:bg-slate-700 hover:border-purple-500/50 cursor-pointer transition-all">
                  <input type="checkbox" className="mt-1 w-4 h-4 rounded border-slate-600 text-purple-500 focus:ring-purple-500 bg-slate-800" />
                  <div>
                    <div className="font-bold text-slate-200 group-hover:text-white">CORS 跨域失败</div>
                    <div className="text-xs text-slate-400 mt-1">移除 Access-Control-Allow-Origin 头，模拟跨域拦截。</div>
                  </div>
                </label>
              </div>

              {/* Column 3: Data */}
              <div className="space-y-4">
                <div className="flex items-center gap-2 text-red-400 font-bold text-sm uppercase tracking-wider mb-2">
                  <FileWarning className="w-4 h-4" /> 数据完整性
                </div>
                
                {/* NEW: Field Type Mutation */}
                <label className="group flex items-start gap-3 p-4 bg-slate-700/30 rounded-xl border border-slate-700/50 hover:bg-slate-700 hover:border-red-500/50 cursor-pointer transition-all">
                  <input type="checkbox" defaultChecked className="mt-1 w-4 h-4 rounded border-slate-600 text-red-500 focus:ring-red-500 bg-slate-800" />
                  <div>
                    <div className="font-bold text-slate-200 group-hover:text-white flex items-center gap-2">
                      字段类型突变 (Mutation)
                      <span className="text-[10px] bg-red-500/20 text-red-300 px-1.5 py-0.5 rounded border border-red-500/30">NEW</span>
                    </div>
                    <div className="text-xs text-slate-400 mt-1">
                      随机修改 JSON 字段类型 (如 <code className="bg-slate-800 px-1 rounded">String</code>→<code className="bg-slate-800 px-1 rounded">Number</code>, <code className="bg-slate-800 px-1 rounded">Array</code>→<code className="bg-slate-800 px-1 rounded">Null</code>)，测试前端类型容错。
                    </div>
                  </div>
                </label>

                <label className="group flex items-start gap-3 p-4 bg-slate-700/30 rounded-xl border border-slate-700/50 hover:bg-slate-700 hover:border-red-500/50 cursor-pointer transition-all">
                  <input type="checkbox" className="mt-1 w-4 h-4 rounded border-slate-600 text-red-500 focus:ring-red-500 bg-slate-800" />
                  <div>
                    <div className="font-bold text-slate-200 group-hover:text-white">垃圾响应体 (Garbage)</div>
                    <div className="text-xs text-slate-400 mt-1">返回非 JSON 格式的乱码或 HTML，测试解析器健壮性。</div>
                  </div>
                </label>

                <label className="group flex items-start gap-3 p-4 bg-slate-700/30 rounded-xl border border-slate-700/50 hover:bg-slate-700 hover:border-red-500/50 cursor-pointer transition-all">
                  <input type="checkbox" className="mt-1 w-4 h-4 rounded border-slate-600 text-red-500 focus:ring-red-500 bg-slate-800" />
                  <div>
                    <div className="font-bold text-slate-200 group-hover:text-white">超大响应 (Big Payload)</div>
                    <div className="text-xs text-slate-400 mt-1">注入大量重复数据 (5MB+)，测试内存和渲染性能。</div>
                  </div>
                </label>
              </div>

            </div>
            
            <div className="px-6 py-3 bg-slate-900/50 border-t border-slate-700 text-xs text-slate-500 text-center">
              提示：Chaos 模式开启时，所有 API 的 Response Tab 配置将被随机覆盖。
            </div>
          </div>
        </div>
      )}


      {/* ====================================================================================
          3. MAIN WORKSPACE
         ==================================================================================== */}
      <div className="flex flex-1 overflow-hidden">
        
        {/* Sidebar - API List */}
        <div className="w-64 bg-white border-r border-slate-200 flex flex-col z-10">
          <div className="p-3 border-b border-slate-100">
            <div className="relative">
              <Search className="w-4 h-4 absolute left-3 top-2.5 text-slate-400" />
              <input type="text" placeholder="Filter APIs..." className="w-full pl-9 pr-3 py-2 bg-slate-100 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 transition-all" />
            </div>
          </div>
          <div className="flex-1 overflow-y-auto px-2 space-y-1 pt-2">
            <div className="group flex items-center gap-3 p-3 bg-indigo-50 rounded-lg border border-indigo-100 cursor-pointer relative overflow-hidden">
              <div className="absolute left-0 top-0 bottom-0 w-1 bg-indigo-500"></div>
              <span className="text-[10px] font-bold px-1.5 py-0.5 bg-green-100 text-green-700 rounded">POST</span>
              <div className="flex-1 min-w-0">
                <div className="text-sm font-bold text-indigo-900 truncate">/api/pay/create</div>
                <div className="text-xs text-indigo-600/70 truncate">创建支付订单</div>
              </div>
            </div>
            
            <div className="group flex items-center gap-3 p-3 hover:bg-slate-50 rounded-lg border border-transparent hover:border-slate-200 cursor-pointer transition-all">
              <span className="text-[10px] font-bold px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded">GET</span>
              <div className="flex-1 min-w-0">
                <div className="text-sm font-medium text-slate-700 truncate">/api/user/info</div>
                <div className="text-xs text-slate-400 truncate">获取用户信息</div>
              </div>
            </div>
          </div>
          
          <div className="p-3 border-t border-slate-200 bg-slate-50">
             <button className="w-full flex items-center justify-center gap-2 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium text-slate-600 hover:text-indigo-600 hover:border-indigo-200 transition-colors shadow-sm">
               <Plus className="w-4 h-4" /> New Endpoint
             </button>
          </div>
        </div>

        {/* Editor Content */}
        <div className="flex-1 flex flex-col min-w-0 bg-slate-50/50">
          
          {/* API Header */}
          <div className="h-16 bg-white border-b border-slate-200 px-6 flex items-center justify-between shadow-sm z-10">
            <div className="flex items-center gap-4">
              <span className="text-xs font-bold px-2 py-1 bg-green-100 text-green-700 rounded border border-green-200">POST</span>
              <div>
                 <div className="text-lg font-bold text-slate-800">/api/pay/create</div>
                 <div className="text-xs text-slate-400">Mock ID: 8839201 • Last updated 2 mins ago</div>
              </div>
            </div>
            
            <div className="flex items-center gap-4">
              {/* Tabs */}
              <div className="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                <button 
                  onClick={() => setActiveTab('response')}
                  className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all flex items-center gap-2 ${activeTab === 'response' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                >
                  <FileJson className="w-3 h-3" /> Response
                </button>
                <button 
                  onClick={() => setActiveTab('network')}
                  className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all flex items-center gap-2 ${activeTab === 'network' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                >
                  <Wifi className="w-3 h-3" /> Network
                </button>
              </div>
              
              <div className="h-6 w-px bg-slate-200"></div>

              <button className="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold transition-colors shadow-sm">
                <PlayCircle className="w-4 h-4" />
                Save & Apply
              </button>
            </div>
          </div>

          {/* Tab Content */}
          <div className="flex-1 overflow-y-auto p-6">
            
            {/* TAB 1: RESPONSE */}
            {activeTab === 'response' && (
              <div className="flex gap-6 h-full animate-in fade-in slide-in-from-bottom-2 duration-300">
                <div className="flex-1 flex flex-col gap-4">
                  {/* Status & Meta Bar */}
                  <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                    <div className="flex items-center gap-2">
                       <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Status Code</span>
                       <select 
                          value={currentConfig.status}
                          onChange={(e) => setCurrentConfig({...currentConfig, status: parseInt(e.target.value)})}
                          className={`px-3 py-1.5 rounded-lg border text-sm font-mono font-bold outline-none focus:ring-2 focus:ring-offset-1 transition-all cursor-pointer ${currentConfig.status >= 400 ? 'bg-red-50 border-red-200 text-red-700 focus:ring-red-500' : 'bg-green-50 border-green-200 text-green-700 focus:ring-green-500'}`}
                        >
                          <option value="200">200 OK</option>
                          <option value="201">201 Created</option>
                          <option value="400">400 Bad Request</option>
                          <option value="404">404 Not Found</option>
                          <option value="500">500 Server Error</option>
                        </select>
                    </div>
                    <div className="h-4 w-px bg-slate-200"></div>
                    <div className="flex items-center gap-2">
                       <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Content-Type</span>
                       <span className="text-xs font-mono text-slate-700 bg-slate-100 px-2 py-1 rounded border border-slate-200">application/json</span>
                    </div>
                    <div className="ml-auto flex gap-2">
                       <button className="text-xs font-medium text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded transition-colors">Format JSON</button>
                    </div>
                  </div>

                  {/* Editor */}
                  <div className="flex-1 flex flex-col bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden relative group">
                    <textarea 
                      className="flex-1 w-full p-6 font-mono text-sm text-slate-700 bg-white focus:outline-none resize-none z-10 relative bg-transparent leading-relaxed"
                      value={currentConfig.body}
                      onChange={(e) => setCurrentConfig({...currentConfig, body: e.target.value})}
                    />
                    
                    {/* Chaos Watermark */}
                    {globalChaos && (
                      <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                        <div className="transform -rotate-12 border-4 border-orange-500/10 text-orange-500/10 text-6xl font-black uppercase p-8 rounded-xl">
                          Chaos Active
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Right: Response Library */}
                <div className="w-80 flex flex-col bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                  <div className="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h3 className="font-bold text-slate-700 text-xs uppercase tracking-wider flex items-center gap-2">
                      <Server className="w-3 h-3" />
                      Response Library
                    </h3>
                    <button className="p-1 hover:bg-slate-200 rounded text-slate-400">
                      <MoreHorizontal className="w-3 h-3" />
                    </button>
                  </div>
                  
                  <div className="flex-1 overflow-y-auto p-3 space-y-3">
                    {responseLibrary.map((item) => (
                      <div 
                        key={item.id} 
                        onClick={() => setCurrentConfig({ status: item.status, body: item.body })} 
                        className="group relative p-3 rounded-lg border border-slate-100 bg-white hover:border-indigo-300 hover:shadow-md cursor-pointer transition-all duration-200"
                      >
                        <div className="flex justify-between mb-2">
                          <span className="text-xs font-bold text-slate-700 group-hover:text-indigo-700 transition-colors">{item.name}</span>
                          <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${item.status < 400 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                            {item.status}
                          </span>
                        </div>
                        <div className="text-[10px] text-slate-400 truncate font-mono bg-slate-50 p-1.5 rounded border border-slate-100 group-hover:bg-white group-hover:border-indigo-100 transition-colors">
                          {item.body.replace(/\s/g, '').substring(0, 40)}...
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* TAB 2: NETWORK */}
            {activeTab === 'network' && (
              <div className="max-w-2xl animate-in fade-in slide-in-from-bottom-2 duration-300">
                <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm space-y-8">
                  {/* Header Info */}
                  <div className="flex items-start gap-4 pb-6 border-b border-slate-100">
                    <div className="p-3 bg-blue-50 text-blue-600 rounded-xl">
                      <Clock className="w-6 h-6" />
                    </div>
                    <div className="flex-1">
                      <h3 className="text-base font-bold text-slate-800">API 专属延迟配置</h3>
                      <p className="text-sm text-slate-500 mt-1 leading-relaxed">
                        此处的配置优先级<b>高于</b>全局网络设置。
                      </p>
                    </div>
                  </div>
                  {/* Controls (Simplified for brevity) */}
                  <div className="space-y-6">
                     <label className="flex items-center justify-between p-4 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 hover:border-blue-300 transition-all group">
                      <div className="flex items-center gap-3">
                        <div className="w-5 h-5 rounded-full border-2 border-slate-300 flex items-center justify-center group-hover:border-blue-500">
                          <div className="w-2.5 h-2.5 rounded-full bg-blue-500 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        </div>
                        <span className="text-sm font-bold text-slate-700">跟随全局设置</span>
                      </div>
                      <span className="text-xs font-mono font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded">
                        Current: {globalNetwork}
                      </span>
                    </label>
                  </div>
                </div>
              </div>
            )}

          </div>
        </div>
      </div>
    </div>
  );
};

export default MockToolUI;
